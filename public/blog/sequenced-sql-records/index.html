
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sequenced SQL Records - The Endless Obsession</title>
  <meta name="author" content="Bryan Matthews">

  
  <meta name="description" content="How to sequence values in a table.  The non-so-elegant solution&#8230; Imagine you have a table that contains records with a foreign key (string, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://endlessobsession.heroku.com/blog/sequenced-sql-records">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="The Endless Obsession" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Endless Obsession</a></h1>
  
    <h2>better code</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:endlessobsession.heroku.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Sequenced SQL Records</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-27T18:17:20-04:00" pubdate data-updated="true">Jul 27<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>How to sequence values in a table.  The non-so-elegant solution&#8230;</h3>

<p>Imagine you have a table that contains records with a foreign key (string, int, guid, etc&#8230;) and an index or sequence number, 1-3, so that there are three records for each foreign key value.  In another table you have any number of records that contain the same foreign key, as well as a value field (date, number, string, etc&#8230;) that can be sequenced in some logical fashion corresponding to the sequence 1-3 in the key table.  You mission (should you choose to accept it) is to get the values from the value table and join them to the corresponding sequence records in the key table.</p>

<p>What follows is the answer I arrived at late this afternoon.  Please let me know if you have a better way.</p>

<ul>
<li><p>declare @dates table(num varchar(9), date datetime)</p></li>
<li></li>
<li><p>insert into @dates</p></li>
<li><p>select &#8216;192837465&#8217;, cast(&#8216;1/3/2008&#8217; as datetime) union</p></li>
<li><p>select &#8216;192837465&#8217;, cast(&#8216;3/12/2003&#8217; as datetime) union</p></li>
<li><p>select &#8216;192837465&#8217;, cast(&#8216;5/22/2010&#8217; as datetime) union</p></li>
<li><p>select &#8216;192837465&#8217;, cast(&#8216;2/1/2004&#8217; as datetime)</p></li>
<li></li>
<li><p>declare @keys table(num varchar(9), sequence int)</p></li>
<li></li>
<li><p>insert into @keys</p></li>
<li><p>select &#8216;192837465&#8217;, 1 union</p></li>
<li><p>select &#8216;192837465&#8217;, 2 union</p></li>
<li><p>select &#8216;192837465&#8217;, 3</p></li>
<li></li>
<li><p>select</p></li>
<li><p>k.num,</p></li>
<li><p>k.sequence,</p></li>
<li><p>date = (select MIN(t.date) from (select top 1 date from @dates where num = k.num order by date desc) t)</p></li>
<li><p>from @keys k</p></li>
<li><p>where sequence = 1</p></li>
<li><p>union</p></li>
<li><p>select</p></li>
<li><p>k.num,</p></li>
<li><p>k.sequence,</p></li>
<li><p>date = (select MIN(t.date) from (select top 2 date from @dates where num = k.num order by date desc) t)</p></li>
<li><p>from @keys k</p></li>
<li><p>where sequence = 2</p></li>
<li><p>union</p></li>
<li><p>select</p></li>
<li><p>k.num,</p></li>
<li><p>k.sequence,</p></li>
<li><p>date = (select MIN(t.date) from (select top 3 date from @dates where num = k.num order by date desc) t)</p></li>
<li><p>from @keys k</p></li>
<li><p>where sequence = 3</p></li>
</ul>


<p>I union the key table 3 times, filtering by each sequence number.  In each sub-query, the value is obtained by selecting the top N values, filtered by the foreign key and ordered by their value (descending), and then getting the min value.</p>

<p>Kind of an odd-ball case, but I might find this humorous one day.  And Pete will laugh, because I laughed at my code.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bryan Matthews</span></span>

      








  


<time datetime="2010-07-27T18:17:20-04:00" pubdate data-updated="true">Jul 27<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/database/'>database</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://endlessobsession.heroku.com/blog/sequenced-sql-records" data-via="BryanMatthews" data-counturl="http://endlessobsession.heroku.com/blog/sequenced-sql-records" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/getting-things-done" title="Previous Post: Getting things done (GTD)">&laquo; Getting things done (GTD)</a>
      
      
        <a class="basic-alignment right" href="/blog/getting-things-done-smart-lists" title="Next Post: Getting Things Done:  Smart Lists">Getting Things Done:  Smart Lists &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/learning-f-with-tdd-part-2">Learning F# with TDD: Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/exoweb-type-loading-changes">ExoWeb type loading changes</a>
      </li>
    
      <li class="post">
        <a href="/blog/learning-fsharp-with-tdd-part-1">Learning F# with TDD: Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/disable-the-audible-beep-in-mac-terminal">Disable the audible beep in Mac Terminal</a>
      </li>
    
      <li class="post">
        <a href="/blog/tfs-rollback-2">Tfs Rollback</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mattheyan">@mattheyan</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mattheyan',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("BryanMatthews", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/BryanMatthews" class="twitter-follow-button" data-show-count="false">Follow @BryanMatthews</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/mattheyan?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Bryan Matthews -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
