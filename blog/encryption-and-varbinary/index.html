<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Encryption and VARBINARY - The Endless Obsession
    </title>
    <meta name="author" content="Bryan Matthews">
    <meta name="description" content="The personal blog of Bryan Matthews"><!-- Viewport and Media Queries: http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://endlessobsession.com/" rel="canonical">
    <link href="/infinity-symbol.png" rel="icon">
    <link href="/atom.xml" rel="alternate" type="application/atom+xml" title="The Endless Obsession">
    <link href="/stylesheets/normalize-3.0.2.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/theme-2.0.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/tomorrow.css" media="screen, projection" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="container">
      <header role="banner">
        <hgroup>
          <h1><a href="http://endlessobsession.com/">The Endless Obsession</a></h1><small>better code</small>
        </hgroup>
        <nav role="navigation">
          <ul>
            <li><a href="http://endlessobsession.com/">Home</a></li>
            <li><a href="http://endlessobsession.com/about" rel="author">About</a></li>
            <li><a href="http://endlessobsession.com/blog/archives">Archives</a></li>
          </ul>
          <form action="http://google.com/search">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:http://endlessobsession.com/">
              <input type="text" name="q" results="0" placeholder="Search" class="search">
            </fieldset>
          </form>
        </nav>
        <nav role="complementary">
          <ul>
            <li><a href="/atom.xml" title="RSS">RSS</a></li>
            <li><a href="https://github.com/mattheyan" title="Github: mattheyan" target="_blank">Github</a></li>
            <li><a href="https://twitter.com/BryanMatthews" title="Twitter: @BryanMatthews" target="_blank">Twitter</a></li>
          </ul>
        </nav>
      </header>
      <main>
        <article>
          <header>
            <h2 class="title">Encryption and VARBINARY</h2>
            <div class="byline"><span class="author">Bryan Matthews</span>
              <time datetime="2010-02-10" pubdate>Feb 10th, 2010</time>
            </div>
          </header>
          <section><p>Data loss is a scary thing.  In one of the apps I have worked on it is particularly scary since some of the data is encrypted.  In the beginning it was encrypted in such a way that it would be (hopefully) impossible to retrieve without the proper authorization.  Essentially, the data would be junk if a finite number of users forgot their passwords.  This was always lurking in the back of my mind.  (You’ve never forgotten your password, have you?)  Luckily we dropped that approach, but I didn’t anticipate how we would actually lose&nbsp;data.</p>
<p>One day I discovered an interesting error was occurring.  (Only in hindsight can I refer to it as “interesting”.)  It was a <em>CryptographicException</em>:  Length of the data to decrypt is invalid.  The application was attempting to load some encrypted data from the database and was repeatedly failing on a particular record.  This is not&nbsp;good.</p>
<p>At first I thought:  “Maybe there is a character or combination of characters in the source text that is causing the problem.”  Looking back I can see that it was a poor attempt at an explanation.  To be fair, I was alerted to the problem by a user who also informed me that he had used a random text generation feature (possibly for the first time), so I was a little biased.  I was able to verify that the data was an odd size (as expected) and the encryption algorithm expected blocks of a certain number of bytes.  However, I could not reproduce the bug since I had no idea what the original source text&nbsp;was.</p>
<p>Fast-forward a week or two.  The problem occurs again, but this time the user is working with a known value.  I crack open the test system and, lo and behold, the error is reproducible!  After doing some debugging and tracing I come to the conclusion that <span class="caps">SQL</span> Server is truncating my data.  (How rude!?)  From there it didn’t take long for me to discover an interesting property of the column in question.  Getting info on the table told me that the “TrimTrailingSpace” property was true (which corresponds to <a href="http://msdn.microsoft.com/en-us/library/ms187403.aspx"><em><span class="caps">ANSI</span> PADDING</em></a>).  It doesn’t take a genius to figure out that something is wrong with&nbsp;that.</p>
<p>Luckily I found <a href="http://support.microsoft.com/kb/296559"><em>this article</em></a>, which indicates that any alter of the column will turn off “TrimTrailingSpace”, just what I wanted.  So, what did I do?  Something like&nbsp;this:</p>
<pre><code class="lang-sql"><span class="operator"><span class="keyword"><span class="caps">ALTER</span></span> <span class="keyword"><span class="caps">TABLE</span></span> MyTable
<span class="keyword"><span class="caps">ALTER</span></span> <span class="keyword"><span class="caps">COLUMN</span></span> MyColumn <span class="caps">VARBINARY</span>(xxx);</span>
</code></pre>
<p>Problem&nbsp;solved!</p>
</section>
          <section>
            <h2>Comments</h2>
            <div id="disqus_thread"></div>
          </section>
        </article>
        <footer>
          <script type="text/javascript" src="/javascripts/disqus.js?v=2.0.0&amp;name=endlessobsession"></script><small>Copyright &copy; 2016 - Bryan Matthews &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a></small>
          <script type="text/javascript" src="/javascripts/analytics.js?v=1.0.0&amp;id=UA-17782995-1"></script>
        </footer>
      </main>
    </div>
  </body>
</html>